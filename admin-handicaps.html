<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Handicap Editor</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-main: #050713;
      --bg-card: #10121e;
      --bg-card-soft: #151827;
      --accent-aqua: #1eeaf0;
      --text-main: #ecf8ff;
      --text-muted: #8a90a4;
      --border-subtle: #2a2e45;
      --success: #bbf7d0;
      --error: #fecaca;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: "Kanit", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #15192f 0, transparent 50%),
        radial-gradient(circle at bottom right, #141a2c 0, transparent 55%),
        var(--bg-main);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 920px;
      padding: 20px 16px 32px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 16px;
      background: linear-gradient(120deg, #050713, #10121f 40%, #050713 100%);
      border: 1px solid rgba(30, 234, 240, 0.2);
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .signin-card {
      margin-top: 12px;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(42, 46, 69, 0.9);
      background: var(--bg-card);
    }

    .signin-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .signin-row input {
      flex: 1;
      min-width: 200px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-card-soft);
      color: var(--text-main);
      font-size: 14px;
    }

    .card {
      background: radial-gradient(circle at top left, #1c2036 0, #10121e 55%);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(42, 46, 69, 0.9);
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
    }

    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .toolbar input {
      flex: 1;
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-card-soft);
      color: var(--text-main);
      font-size: 14px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: var(--accent-aqua);
      color: #050713;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .btn.secondary {
      background: #232536;
      color: var(--text-main);
      border: 1px solid #323552;
      text-transform: none;
    }

    .status {
      font-size: 12px;
      color: var(--text-muted);
    }

    .status.success { color: var(--success); }
    .status.error { color: var(--error); }

    .hidden {
      display: none !important;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid #232844;
    }

    th {
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
      color: var(--text-muted);
    }

    .handicap-input {
      width: 80px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-card-soft);
      color: var(--text-main);
      text-align: center;
    }

    .row-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    @media (max-width: 640px) {
      th:nth-child(3), td:nth-child(3) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <h1>Handicap Editor</h1>
      <div class="header-actions">
        <div class="status" id="authStatus">Checking access...</div>
        <a class="btn secondary hidden" id="loginLink" href="login.html">Sign in</a>
      </div>
    </div>

    <div class="signin-card hidden" id="signinCard">
      <div class="signin-row">
        <input id="signinEmail" type="email" placeholder="Email" autocomplete="email" />
        <input id="signinPassword" type="password" placeholder="Password" autocomplete="current-password" />
        <button class="btn" id="signinBtn" type="button">Sign in</button>
      </div>
      <div class="status" id="signinStatus"></div>
    </div>

    <div class="card">
      <div class="toolbar">
        <input id="searchInput" type="text" placeholder="Search by name or UID" />
        <button class="btn" id="saveAllBtn" type="button">Save all</button>
        <button class="btn secondary" id="refreshBtn" type="button">Refresh</button>
      </div>
      <div class="status" id="pageStatus"></div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Handicap</th>
              <th>UID</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYat6m3-Lv46vfm6xcHLjTjRDq7NdCxAk",
      authDomain: "hackers-cup.firebaseapp.com",
      databaseURL: "https://hackers-cup-default-rtdb.firebaseio.com",
      projectId: "hackers-cup",
      storageBucket: "hackers-cup.appspot.com",
      messagingSenderId: "765736070872",
      appId: "1:765736070872:web:86a51c41916e7af75631ad",
      measurementId: "G-6E1M14F510"
    };


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const authStatus = document.getElementById('authStatus');
    const pageStatus = document.getElementById('pageStatus');
    const tableBody = document.getElementById('tableBody');
    const searchInput = document.getElementById('searchInput');
    const saveAllBtn = document.getElementById('saveAllBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const loginLink = document.getElementById('loginLink');
    const signinCard = document.getElementById('signinCard');
    const signinEmail = document.getElementById('signinEmail');
    const signinPassword = document.getElementById('signinPassword');
    const signinBtn = document.getElementById('signinBtn');
    const signinStatus = document.getElementById('signinStatus');

    let users = [];
    const dirty = new Map();

    function setStatus(el, msg, type = "") {
      el.textContent = msg || "";
      el.classList.remove("success", "error");
      if (type) el.classList.add(type);
    }


    function normalize(value) {
      return String(value || "").toLowerCase();
    }

    async function handleSignIn() {
      const email = signinEmail.value.trim();
      const password = signinPassword.value;
      if (!email || !password) {
        setStatus(signinStatus, "Enter email and password.", "error");
        return;
      }
      setStatus(signinStatus, "Signing in...");
      try {
        await signInWithEmailAndPassword(auth, email, password);
        signinPassword.value = "";
        setStatus(signinStatus, "Signed in.", "success");
      } catch (e) {
        console.error(e);
        setStatus(signinStatus, "Sign-in failed.", "error");
      }
    }

    function renderRows(list) {
      tableBody.innerHTML = "";
      list.forEach(user => {
        const tr = document.createElement('tr');
        const name = user.displayName || "(no name)";
        const uid = user.uid;
        const handicap = Number.isFinite(user.handicap) ? user.handicap : "";

        tr.innerHTML = `
          <td>${name}</td>
          <td>
            <input class="handicap-input" type="number" min="0" max="54" value="${handicap}" data-uid="${uid}" />
          </td>
          <td>${uid}</td>
          <td>
            <div class="row-actions">
              <button class="btn secondary" type="button" data-save="${uid}">Save</button>
            </div>
          </td>
        `;

        tableBody.appendChild(tr);
      });
    }

    function filterAndRender() {
      const q = normalize(searchInput.value);
      const filtered = users.filter(u => {
        return normalize(u.displayName).includes(q) || normalize(u.uid).includes(q);
      });
      renderRows(filtered);
    }

    async function loadUsers() {
      setStatus(pageStatus, "Loading users...");
      const snap = await get(ref(db, 'users'));
      if (!snap.exists()) {
        users = [];
        renderRows([]);
        setStatus(pageStatus, "No users found.", "error");
        return;
      }

      const data = snap.val();
      users = Object.keys(data).map(uid => {
        const u = data[uid] || {};
        return {
          uid,
          displayName: u.displayName || "",
          handicap: Number(u.handicap)
        };
      });

      users.sort((a, b) => (a.displayName || "").localeCompare(b.displayName || ""));
      filterAndRender();
      setStatus(pageStatus, "Loaded.", "success");
    }

    async function saveHandicap(uid, value) {
      const num = Number(value);
      if (Number.isNaN(num)) {
        setStatus(pageStatus, "Invalid handicap value.", "error");
        return;
      }
      await set(ref(db, `users/${uid}/handicap`), num);
    }

    tableBody.addEventListener('input', (event) => {
      const target = event.target;
      if (!target.matches('.handicap-input')) return;
      dirty.set(target.dataset.uid, target.value);
    });

    tableBody.addEventListener('click', async (event) => {
      const btn = event.target.closest('[data-save]');
      if (!btn) return;
      const uid = btn.getAttribute('data-save');
      const input = tableBody.querySelector(`.handicap-input[data-uid="${uid}"]`);
      try {
        await saveHandicap(uid, input.value);
        dirty.delete(uid);
        setStatus(pageStatus, `Saved handicap for ${uid}.`, "success");
      } catch (e) {
        console.error(e);
        setStatus(pageStatus, "Save failed.", "error");
      }
    });

    saveAllBtn.addEventListener('click', async () => {
      if (dirty.size === 0) {
        setStatus(pageStatus, "No changes to save.", "success");
        return;
      }
      setStatus(pageStatus, "Saving changes...");
      try {
        for (const [uid, value] of dirty.entries()) {
          await saveHandicap(uid, value);
        }
        dirty.clear();
        setStatus(pageStatus, "All changes saved.", "success");
      } catch (e) {
        console.error(e);
        setStatus(pageStatus, "Some saves failed.", "error");
      }
    });

    refreshBtn.addEventListener('click', loadUsers);
    searchInput.addEventListener('input', filterAndRender);
    signinBtn.addEventListener('click', handleSignIn);

    setPersistence(auth, browserLocalPersistence).catch((error) => {
      console.warn('Auth persistence error:', error);
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setStatus(authStatus, "Please sign in to continue.", "error");
        loginLink.classList.remove('hidden');
        signinCard.classList.remove('hidden');
        return;
      }

      loginLink.classList.add('hidden');
      signinCard.classList.add('hidden');
      setStatus(authStatus, `Signed in as ${user.email || user.uid}`, "success");
      await loadUsers();
    });
  </script>
</body>
</html>
